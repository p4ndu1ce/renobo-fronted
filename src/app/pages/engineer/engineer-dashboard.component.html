<div class="engineer-page min-h-screen">
  <div class="max-w-lg mx-auto px-4 py-6 sm:py-8">
    <section class="mb-6">
      <app-wallet-card
        [balance]="walletService.balance()"
        subtitle="Comisiones por cobrar"
        currency="USD"
        badge="+12.5%"
      />
    </section>
    @if (successMessage()) {
      <div class="mb-4 rounded-2xl bg-emerald-50 border border-emerald-200 px-4 py-3 text-emerald-800 text-sm font-medium flex items-center gap-2">
        <span aria-hidden="true">‚úì</span>
        {{ successMessage() }}
      </div>
    }
    <header class="mb-6 sm:mb-8">
      <h1 class="text-2xl sm:text-3xl font-black text-slate-900 tracking-tight">Hoja de ruta t√©cnica</h1>
      <p class="text-slate-500 font-medium mt-1 text-sm sm:text-base">Visitas pendientes asignadas a ti. Toca una obra para ver la intenci√≥n del cliente e iniciar el relevamiento.</p>
    </header>

    @if (assignedWorks().length === 0) {
      <div class="rounded-[2.5rem] bg-white border border-slate-200 shadow-sm p-8 sm:p-10 text-center">
        <p class="text-4xl mb-4">üìã</p>
        <h2 class="text-lg font-bold text-slate-800 mb-2">Sin obras asignadas</h2>
        <p class="text-sm text-slate-500">No tienes visitas pendientes, obras en espera de proveedores ni en curso.</p>
      </div>
    } @else {
      <ul class="space-y-4 sm:space-y-5">
        @for (work of assignedWorks(); track work.id) {
          <li
            class="rounded-[2.5rem] bg-white border-2 shadow-sm overflow-hidden transition-all cursor-pointer"
            [class.border-[#fa5404]]="selectedWorkId() === work.id"
            [class.border-slate-200]="selectedWorkId() !== work.id"
            (click)="selectWork(work)"
          >
            <div class="p-5 sm:p-6">
              <p class="text-xl sm:text-2xl font-black text-slate-900">{{ work.title || 'Sin t√≠tulo' }}</p>
              <p class="text-slate-500 text-sm mt-1">{{ work.userId || '‚Äî' }}</p>
              <div class="flex flex-wrap items-center gap-2 mt-3">
                <span class="inline-block px-3 py-1.5 rounded-full text-xs font-bold bg-[#fa5404]/15 text-[#fa5404] border border-[#fa5404]/30">
                  Plan {{ work.planLabel }}
                </span>
                <span
                  class="inline-block px-3 py-1.5 rounded-full text-xs font-bold"
                  [class.bg-amber-50]="work.status === 'TECHNICAL_VISIT_PENDING'"
                  [class.text-amber-700]="work.status === 'TECHNICAL_VISIT_PENDING'"
                  [class.bg-sky-50]="work.status === 'WAITING_PARTNERS'"
                  [class.text-sky-700]="work.status === 'WAITING_PARTNERS'"
                  [class.bg-emerald-50]="work.status === 'IN_PROGRESS'"
                  [class.text-emerald-700]="work.status === 'IN_PROGRESS'"
                >
                  {{ getStatusLabel(work.status) }}
                </span>
              </div>
            </div>

            @if (selectedWorkId() === work.id && selectedWork(); as w) {
              <div class="border-t border-slate-200 bg-slate-50/80 px-5 sm:p-6 py-5">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Intenci√≥n del Cliente</h3>
                <p class="font-bold text-slate-900 text-lg mb-1">{{ w.title || 'Sin t√≠tulo' }}</p>
                <p class="text-slate-600 text-sm whitespace-pre-wrap">{{ getWorkDescription(w) }}</p>
                @if (w.status === 'TECHNICAL_VISIT_PENDING') {
                  <button
                    type="button"
                    (click)="startRelevamiento(w)"
                    class="mt-5 w-full py-4 rounded-2xl text-white font-bold text-base transition-colors shadow-lg hover:opacity-95"
                    style="background-color: #fa5404"
                  >
                    Iniciar Relevamiento T√©cnico
                  </button>
                }
                @if (w.status === 'WAITING_PARTNERS') {
                  <p class="mt-3 text-sm text-amber-700 font-medium">Esperando confirmaci√≥n de proveedores. Abre la obra para marcar qui√©n confirm√≥ stock e iniciar.</p>
                  <button
                    type="button"
                    (click)="startRelevamiento(w)"
                    class="mt-4 w-full py-4 rounded-2xl text-white font-bold text-base transition-colors shadow-lg hover:opacity-95"
                    style="background-color: #fa5404"
                  >
                    Ver checklist y solicitar disponibilidad
                  </button>
                }
                @if (w.status === 'IN_PROGRESS') {
                  <p class="mt-3 text-sm text-emerald-700 font-medium">Obra en curso.</p>
                  <app-loading-button
                    label="Finalizar obra"
                    [isLoading]="isFinishingWork()"
                    [disabled]="false"
                    btnClass="mt-4 w-full py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-base transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    (clicked)="finishWork(w)"
                  />
                }
              </div>
            }
          </li>
        }
      </ul>
    }
  </div>
</div>
