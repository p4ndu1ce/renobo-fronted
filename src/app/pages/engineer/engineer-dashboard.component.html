<div class="engineer-page min-h-screen bg-orange-50 pb-20">
  <!-- Header: mismo estilo que /tracking (barra con volver + título) -->
  <header class="flex items-center gap-3 px-4 py-3 border-b border-orange-100/50 bg-white/80">
    <a routerLink="/home" class="p-2 -m-2 rounded-lg hover:bg-orange-100 text-slate-700 transition-colors" aria-label="Volver">
      <lucide-icon [name]="icons.ArrowLeft" class="w-6 h-6"></lucide-icon>
    </a>
    <h1 class="text-xl font-bold text-slate-900">Servicios asignados</h1>
  </header>

  <div class="max-w-lg mx-auto px-4 py-4 pb-20">
    @if (successMessage()) {
      <div class="mb-4 rounded-xl bg-emerald-50 border border-emerald-200 px-4 py-3 text-emerald-800 text-sm font-medium flex items-center gap-2">
        <span aria-hidden="true">✓</span>
        {{ successMessage() }}
      </div>
    }

    <p class="text-slate-500 text-sm mb-4">Toca un servicio para ver el detalle, agendar visita o abrir el chat con el cliente.</p>

    @if (assignedWorks().length === 0) {
      <div class="p-8 text-center border-2 border-dashed border-slate-200 rounded-xl bg-white">
        <p class="text-sm text-gray-500">No tienes servicios asignados.</p>
      </div>
    } @else {
      <!-- Sin visita agendada -->
      <section class="mb-6">
        <h2 class="text-sm font-bold text-slate-800 mb-3">Sin visita agendada</h2>
        @if (worksWithoutVisit().length === 0) {
          <div class="rounded-xl border border-slate-200 bg-white p-5 text-sm text-slate-500">No tienes servicios pendientes por agendar.</div>
        } @else {
          <div class="space-y-2">
            @for (work of worksWithoutVisit(); track work.id) {
              <div
                class="rounded-xl border border-slate-200 bg-white overflow-hidden cursor-pointer hover:shadow-md transition-shadow active:scale-[0.98]"
                [class.ring-2]="selectedWorkId() === work.id"
                [class.ring-[#FF5500]]="selectedWorkId() === work.id"
                (click)="selectWork(work)"
              >
                <div class="p-4 flex justify-between items-center">
                  <div class="min-w-0 flex-1">
                    <h4 class="font-medium text-foreground">{{ work.title || 'Sin título' }}</h4>
                    <p class="text-sm text-gray-500">{{ formatWorkDate(work) }}</p>
                  </div>
                  <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shrink-0 ml-2 bg-[#FF5500] text-white">
                    {{ getStatusLabel(work.status) }}
                  </span>
                </div>
                @if (selectedWorkId() === work.id && selectedWork(); as w) {
                  <div class="border-t border-slate-200 bg-slate-50/80 p-4">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Detalle</h3>
                    <p class="text-slate-700 text-sm whitespace-pre-wrap">{{ getWorkDescription(w) }}</p>
                    <div class="mt-4 rounded-xl bg-white border border-slate-200 p-4">
                      <h4 class="text-xs font-bold text-slate-600 uppercase tracking-widest mb-3">Agendar visita</h4>
                      <div class="grid grid-cols-2 gap-3">
                        <div>
                          <label class="text-xs font-medium text-slate-500">Fecha</label>
                          <input type="date" class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-200 text-sm"
                            [value]="visitDateByWork()[w.id]" (change)="setVisitDate(w.id, $any($event.target).value)" />
                        </div>
                        <div>
                          <label class="text-xs font-medium text-slate-500">Hora</label>
                          <input type="time" class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-200 text-sm"
                            [value]="visitTimeByWork()[w.id]" (change)="setVisitTime(w.id, $any($event.target).value)" />
                        </div>
                      </div>
                      <div class="flex gap-2 mt-4">
                        <button type="button" (click)="openChat(w)" class="flex-1 py-2.5 rounded-lg border border-slate-200 bg-white text-slate-700 font-medium text-sm hover:bg-slate-50">
                          Abrir chat
                        </button>
                        <button type="button" (click)="scheduleVisit(w)" class="flex-1 py-2.5 rounded-lg bg-[#FF5500] text-white font-medium text-sm hover:bg-[#FF6600]">
                          Agendar
                        </button>
                      </div>
                    </div>
                    <button type="button" (click)="startRelevamiento(w)"
                      class="mt-4 w-full py-3 rounded-xl bg-[#FF5500] text-white font-semibold text-sm hover:bg-[#FF6600] transition-colors">
                      Ver relevamiento / checklist
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }
      </section>

      <!-- Visitas agendadas -->
      <section>
        <h2 class="text-sm font-bold text-slate-800 mb-3">Visitas agendadas</h2>
        @if (worksWithVisit().length === 0) {
          <div class="rounded-xl border border-slate-200 bg-white p-5 text-sm text-slate-500">Aún no tienes visitas agendadas.</div>
        } @else {
          <div class="space-y-2">
            @for (work of worksWithVisit(); track work.id) {
              <div
                class="rounded-xl border border-slate-200 bg-white overflow-hidden cursor-pointer hover:shadow-md transition-shadow active:scale-[0.98]"
                [class.ring-2]="selectedWorkId() === work.id"
                [class.ring-[#FF5500]]="selectedWorkId() === work.id"
                (click)="selectWork(work)"
              >
                <div class="p-4 flex justify-between items-center">
                  <div class="min-w-0 flex-1">
                    <h4 class="font-medium text-foreground">{{ work.title || 'Sin título' }}</h4>
                    <p class="text-sm text-gray-500">{{ formatScheduled($any(work).requestedScheduledDate) }}</p>
                  </div>
                  <span
                    class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shrink-0 ml-2"
                    [class.bg-amber-100]="work.status === 'TECHNICAL_VISIT_PENDING'"
                    [class.text-amber-800]="work.status === 'TECHNICAL_VISIT_PENDING'"
                    [class.bg-sky-100]="work.status === 'WAITING_PARTNERS'"
                    [class.text-sky-800]="work.status === 'WAITING_PARTNERS'"
                    [class.bg-green-500]="work.status === 'IN_PROGRESS'"
                    [class.text-white]="work.status === 'IN_PROGRESS'"
                  >
                    {{ getStatusLabel(work.status) }}
                  </span>
                </div>
                @if (selectedWorkId() === work.id && selectedWork(); as w) {
                  <div class="border-t border-slate-200 bg-slate-50/80 p-4">
                    <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Intención del Cliente</h3>
                    <p class="text-slate-700 text-sm whitespace-pre-wrap">{{ getWorkDescription(w) }}</p>
                    <button type="button" (click)="openChat(w)"
                      class="mt-4 w-full py-2.5 rounded-xl border border-slate-200 bg-white text-slate-700 font-medium text-sm hover:bg-slate-50">
                      Abrir chat con cliente
                    </button>
                    @if (w.status === 'TECHNICAL_VISIT_PENDING') {
                      <button type="button" (click)="startRelevamiento(w)"
                        class="mt-3 w-full py-3 rounded-xl bg-[#FF5500] text-white font-semibold text-sm hover:bg-[#FF6600]">
                        Iniciar Relevamiento Técnico
                      </button>
                    }
                    @if (w.status === 'WAITING_PARTNERS') {
                      <p class="mt-3 text-xs text-amber-700">Esperando confirmación de proveedores.</p>
                      <button type="button" (click)="startRelevamiento(w)"
                        class="mt-2 w-full py-3 rounded-xl bg-[#FF5500] text-white font-semibold text-sm hover:bg-[#FF6600]">
                        Ver checklist
                      </button>
                    }
                    @if (w.status === 'IN_PROGRESS') {
                      <p class="mt-3 text-xs text-emerald-700 font-medium">Obra en curso.</p>
                      <app-loading-button
                        label="Finalizar obra"
                        [isLoading]="isFinishingWork()"
                        [disabled]="false"
                        btnClass="mt-2 w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                        (clicked)="finishWork(w)"
                      />
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
      </section>
    }
  </div>
</div>
