<div class="pagos-page min-h-screen bg-gradient-to-b from-orange-50 to-white pb-20">
  <header class="bg-gradient-to-r from-[#FF5500] to-[#FF6600] text-white p-4 shadow-lg sticky top-0 z-10">
    <div class="flex items-center gap-3">
      <button type="button" (click)="goBack()" class="p-2 -m-2 text-white hover:bg-white/20 rounded-lg transition-colors" aria-label="Volver">
        <lucide-icon [name]="icons.ArrowLeft" class="w-6 h-6"></lucide-icon>
      </button>
      <h1 class="text-xl font-bold">
        @switch (step()) {
          @case (0) { Historial de Pagos }
          @case (1) { Realizar pago - Paso 1 }
          @case (2) { Realizar pago - Paso 2 }
          @case (3) { Comprobante enviado }
        }
      </h1>
    </div>
  </header>

  @if (step() === 0) {
    <!-- Vista principal: próxima cuota + CTA + historial -->
    <div class="p-4 space-y-4">
      <!-- Próxima cuota -->
      @if (nextDue(); as next) {
        <section class="rounded-xl border border-orange-200 bg-white shadow-sm overflow-hidden">
          <div class="p-4 border-b border-orange-100 bg-gradient-to-r from-orange-50 to-white">
            <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Próxima cuota</h2>
            <div class="flex items-baseline justify-between gap-3 flex-wrap">
              <p class="text-2xl font-black text-slate-900">{{ formatAmount(next.amount) }}</p>
              <p class="text-sm text-slate-600 flex items-center gap-1.5 shrink-0">
                <lucide-icon [name]="icons.Calendar" class="w-4 h-4 text-slate-500"></lucide-icon>
                <span>Vence el {{ formatDueDate(next.dueDate) }}</span>
              </p>
            </div>
          </div>
        </section>
      }

      <section class="rounded-xl border border-orange-200 bg-white shadow-sm overflow-hidden">
        <div class="p-4 bg-gradient-to-r from-orange-50 to-white border-b border-orange-100">
          <h2 class="font-bold text-slate-900">Realizar un pago</h2>
          <p class="text-sm text-slate-600 mt-0.5">Transfiere a nuestra cuenta y registra tu comprobante.</p>
          <button type="button" (click)="startPaymentFlow()"
            class="mt-3 w-full py-3 px-4 rounded-xl bg-gradient-to-r from-[#FF5500] to-[#FF6600] hover:from-[#FF6600] hover:to-[#FF7700] text-white font-semibold flex items-center justify-center gap-2 transition-colors">
            <lucide-icon [name]="icons.CreditCard" class="w-5 h-5"></lucide-icon>
            Realizar pago
          </button>
        </div>
      </section>

      @if (payments().length === 0) {
        <section class="rounded-xl border-2 border-dashed border-slate-200 bg-white p-8 text-center">
          <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-slate-100 text-slate-400 mb-4">
            <lucide-icon [name]="icons.CreditCard" class="w-7 h-7"></lucide-icon>
          </div>
          <p class="text-slate-600 font-medium mb-1">No tienes pagos registrados</p>
          <p class="text-sm text-slate-500">Cuando realices un pago, aparecerá aquí.</p>
        </section>
      } @else {
        <p class="text-sm text-slate-600 mb-2">Tus cuotas y pagos realizados</p>
        <ul class="space-y-3">
          @for (payment of payments(); track payment.id) {
            <li class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
              <div class="p-4 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center shrink-0">
                  <lucide-icon [name]="icons.DollarSign" class="w-5 h-5 text-[#FF5500]"></lucide-icon>
                </div>
                <div class="min-w-0 flex-1">
                  <p class="font-semibold text-slate-900">{{ formatAmount(payment.amount) }}</p>
                  @if (payment.description) {
                    <p class="text-sm text-slate-500 truncate">{{ payment.description }}</p>
                  }
                  <p class="text-xs text-slate-400 mt-0.5 flex items-center gap-1">
                    <lucide-icon [name]="icons.Calendar" class="w-3.5 h-3.5"></lucide-icon>
                    {{ formatDate(payment.date) }}
                  </p>
                </div>
              </div>
            </li>
          }
        </ul>
      }
    </div>
  }

  @if (step() === 1) {
    <!-- Paso 1: Datos del banco -->
    <div class="p-4 space-y-4">
      <div class="flex items-center gap-2 text-sm text-slate-600">
        <span class="flex items-center justify-center w-7 h-7 rounded-full bg-[#FF5500] text-white font-bold text-xs">1</span>
        <span>Datos para transferencia</span>
      </div>
      <section class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-4 border-b border-slate-100 bg-slate-50/50">
          <h3 class="font-bold text-slate-900">Realiza tu transferencia o depósito</h3>
          <p class="text-sm text-slate-600 mt-0.5">Usa estos datos y luego registra tu comprobante en el siguiente paso.</p>
        </div>
        <div class="p-4 space-y-4">
          <div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Banco</p>
            <p class="font-medium text-slate-900">{{ bankDetails().bankName }}</p>
          </div>
          <div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Tipo de cuenta</p>
            <p class="font-medium text-slate-900">{{ bankDetails().accountType }}</p>
          </div>
          <div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Número de cuenta</p>
            <p class="font-mono font-medium text-slate-900">{{ bankDetails().accountNumber }}</p>
          </div>
          <div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Beneficiario</p>
            <p class="font-medium text-slate-900">{{ bankDetails().beneficiary }}</p>
            <p class="text-sm text-slate-500">RIF: {{ bankDetails().rif }}</p>
          </div>
          <div class="pt-2 border-t border-slate-100">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Referencia</p>
            <p class="text-sm text-slate-700">{{ bankDetails().referenceFormat }}</p>
          </div>
        </div>
      </section>
      <button type="button" (click)="nextStep()"
        class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-[#FF5500] to-[#FF6600] hover:from-[#FF6600] hover:to-[#FF7700] text-white font-semibold flex items-center justify-center gap-2">
        Siguiente: registrar comprobante
        <lucide-icon [name]="icons.ChevronRight" class="w-5 h-5"></lucide-icon>
      </button>
    </div>
  }

  @if (step() === 2) {
    <!-- Paso 2: Formulario + comprobante -->
    <div class="p-4 space-y-4">
      <div class="flex items-center gap-2 text-sm text-slate-600">
        <span class="flex items-center justify-center w-7 h-7 rounded-full bg-slate-200 text-slate-600 font-bold text-xs">
          <lucide-icon [name]="icons.Check" class="w-4 h-4"></lucide-icon>
        </span>
        <span>Paso 1 completado</span>
      </div>
      <div class="flex items-center gap-2 text-sm text-slate-700">
        <span class="flex items-center justify-center w-7 h-7 rounded-full bg-[#FF5500] text-white font-bold text-xs">2</span>
        <span>Registrar tu pago</span>
      </div>

      <section class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de pago</label>
            <div class="space-y-2">
              <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-orange-50/50 has-[:checked]:border-[#FF5500] has-[:checked]:bg-orange-50">
                <input type="radio" name="paymentType" value="inicial" [ngModel]="paymentType()" (ngModelChange)="paymentType.set($event)" class="text-[#FF5500]">
                <span class="text-slate-800">Pago inicial</span>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-orange-50/50 has-[:checked]:border-[#FF5500] has-[:checked]:bg-orange-50">
                <input type="radio" name="paymentType" value="cuota" [ngModel]="paymentType()" (ngModelChange)="paymentType.set($event)" class="text-[#FF5500]">
                <span class="text-slate-800">Pago de cuota</span>
              </label>
              <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-orange-50/50 has-[:checked]:border-[#FF5500] has-[:checked]:bg-orange-50">
                <input type="radio" name="paymentType" value="adelanto" [ngModel]="paymentType()" (ngModelChange)="paymentType.set($event)" class="text-[#FF5500]">
                <span class="text-slate-800">Adelanto de cuotas</span>
              </label>
            </div>
          </div>

          <div>
            <label for="amount" class="block text-sm font-medium text-slate-700 mb-1">Monto (USD)</label>
            <input id="amount" type="number" min="0" step="0.01" placeholder="Ej: 85"
              [ngModel]="amount()" (ngModelChange)="amount.set($event)"
              class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF5500]/50">
          </div>

          <div>
            <label for="reference" class="block text-sm font-medium text-slate-700 mb-1">Número de referencia</label>
            <input id="reference" type="text" placeholder="Referencia de la transferencia"
              [ngModel]="reference()" (ngModelChange)="reference.set($event)"
              class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF5500]/50">
          </div>

          <div>
            <label for="paymentDate" class="block text-sm font-medium text-slate-700 mb-1">Fecha del pago</label>
            <input id="paymentDate" type="date"
              [ngModel]="paymentDate()" (ngModelChange)="paymentDate.set($event)"
              class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF5500]/50">
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Comprobante de pago</label>
            <p class="text-xs text-slate-500 mb-2">Sube una foto o PDF del comprobante de transferencia o depósito.</p>
            @if (!proofFileName()) {
              <label class="flex flex-col items-center justify-center gap-2 py-6 px-4 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:border-[#FF5500] hover:bg-orange-50/30 transition-colors">
                <input type="file" accept="image/*,.pdf" (change)="onFileSelected($event)" class="hidden">
                <lucide-icon [name]="icons.Upload" class="w-8 h-8 text-slate-400"></lucide-icon>
                <span class="text-sm font-medium text-slate-600">Seleccionar archivo</span>
                <span class="text-xs text-slate-400">JPG, PNG o PDF</span>
              </label>
            } @else {
              <div class="flex items-center justify-between gap-3 p-3 rounded-xl border border-slate-200 bg-slate-50">
                <span class="text-sm font-medium text-slate-800 truncate">{{ proofFileName() }}</span>
                <button type="button" (click)="removeProof()" class="text-slate-500 hover:text-red-600 shrink-0 text-sm">Quitar</button>
              </div>
            }
          </div>
        </div>
      </section>

      <button type="button" (click)="submitPayment()" [disabled]="submitting()"
        class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-[#FF5500] to-[#FF6600] hover:from-[#FF6600] hover:to-[#FF7700] text-white font-semibold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        <lucide-icon [name]="icons.Send" class="w-5 h-5"></lucide-icon>
        Enviar comprobante
      </button>
    </div>
  }

  @if (step() === 3) {
    <!-- Paso 3: Éxito -->
    <div class="p-4 space-y-4">
      <section class="rounded-xl border border-green-200 bg-green-50 p-6 text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-500 text-white mb-4">
          <lucide-icon [name]="icons.CheckCircle2" class="w-8 h-8"></lucide-icon>
        </div>
        <h3 class="font-bold text-lg text-slate-900 mb-1">Comprobante enviado</h3>
        <p class="text-sm text-slate-600">Tu pago será verificado y aparecerá en el historial en breve.</p>
      </section>
      <button type="button" (click)="finishAndBack()"
        class="w-full py-3 px-4 rounded-xl border-2 border-[#FF5500] text-[#FF5500] font-semibold hover:bg-orange-50 transition-colors">
        Volver al historial
      </button>
      <button type="button" (click)="startPaymentFlow()"
        class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-[#FF5500] to-[#FF6600] text-white font-semibold hover:from-[#FF6600] hover:to-[#FF7700] transition-colors">
        Registrar otro pago
      </button>
    </div>
  }
</div>
