<div class="home-by-role max-w-lg mx-auto px-4 sm:px-6" style="background-color: #fff9f3; min-height: 100%;">
  @if (isLoading()) {
    <div class="space-y-3 pt-2">
      <app-skeleton-card [count]="3"></app-skeleton-card>
    </div>
  } @else {
  <!-- CLIENT: Si tiene obra en curso, saludo + tarjeta resumen (stepper) y ocultar planes -->
  @if (userRole() !== 'ENGINEER' && userRole() !== 'SUPERVISOR') {
    @if (currentWork(); as work) {
      <section class="mb-4">
        <h1 class="text-xl font-black text-slate-900 tracking-tight mb-0.5">Inicio</h1>
        <p class="text-slate-500 text-sm">Tu solicitud en curso aparece abajo. Toca la tarjeta para ver el seguimiento completo.</p>
      </section>
      <a
        [routerLink]="['/seguimiento']"
        [queryParams]="{ workId: work.id }"
        class="active-card block rounded-[2.5rem] border-2 border-orange-200 bg-white shadow-md overflow-hidden mb-6 no-underline text-inherit hover:shadow-lg hover:border-[#fa5404]/50 transition-all"
      >
        <div class="p-5">
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Servicio en curso</p>
          <h2 class="text-lg font-bold text-slate-900 mb-1">{{ work.title || 'Sin t√≠tulo' }}</h2>
          <p class="text-sm text-slate-500 mb-4">Plan {{ getPlanLabel(work.planId) }}</p>
          <!-- Stepper horizontal: Cr√©dito ‚Üí Visita T√©cnica ‚Üí Obra -->
          <div class="flex items-center gap-1">
            @for (step of currentWorkSteps(); track step.label; let i = $index) {
              <div class="flex items-center min-w-0 flex-1">
                <div
                  class="shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold transition-colors"
                  [class.bg-[#fa5404]]="step.completed || step.current"
                  [class.text-white]="step.completed || step.current"
                  [class.bg-slate-200]="!step.completed && !step.current"
                  [class.text-slate-500]="!step.completed && !step.current"
                >
                  @if (step.completed) {
                    <span aria-hidden="true">‚úì</span>
                  } @else {
                    <span>{{ i + 1 }}</span>
                  }
                </div>
                <span
                  class="ml-1.5 text-xs font-medium truncate"
                  [class.text-slate-800]="step.current || step.completed"
                  [class.text-slate-400]="!step.current && !step.completed"
                >
                  {{ step.label }}
                </span>
              </div>
              @if (i < currentWorkSteps().length - 1) {
                <div class="shrink-0 w-3 h-0.5 rounded-full bg-slate-200" [class.bg-[#fa5404]]="step.completed"></div>
              }
            }
          </div>
          <p class="mt-3 text-sm font-semibold text-[#fa5404]">Ver seguimiento completo ‚Üí</p>
        </div>
      </a>
    } @else {
    <section class="mb-6">
      <h1 class="text-xl font-black text-slate-900 tracking-tight mb-1">Planes de Financiamiento</h1>
      <p class="text-slate-500 text-sm">Toca una tarjeta para ver condiciones y solicitar.</p>
    </section>

    <section class="flex flex-col gap-4 mb-6">
      @for (plan of clientPlans(); track plan.id) {
        <!-- Contenedor: SIEMPRE fondo blanco; borde naranja solo si est√° seleccionada -->
        <div
          class="plan-card rounded-[2.5rem] overflow-hidden flex flex-col transition-all duration-300 bg-white"
          [class.border-2]="selectedPlan()?.id === plan.id"
          [class.border-[#fa5404]]="selectedPlan()?.id === plan.id"
          [class.border]="selectedPlan()?.id !== plan.id"
          [class.border-slate-200]="selectedPlan()?.id !== plan.id"
          [class.min-h-[100px]]="selectedPlan()?.id !== plan.id"
        >
          <!-- Cabecera (solo aqu√≠ el naranja cuando est√° seleccionada) -->
          <button
            type="button"
            (click)="selectPlan(plan)"
            class="w-full text-left p-5 flex items-start gap-4 transition-colors"
            [class.bg-[#f2f0eb]]="selectedPlan()?.id !== plan.id"
            [class.text-slate-800]="selectedPlan()?.id !== plan.id"
            [class.bg-[#fa5404]]="selectedPlan()?.id === plan.id"
            [class.text-white]="selectedPlan()?.id === plan.id"
          >
            <div class="flex-1 min-w-0">
              <p class="font-bold text-lg">{{ plan.name }}</p>
              <p class="text-sm mt-0.5 opacity-90">Presupuesto: {{ plan.minAmount | currency }} - {{ plan.maxAmount | currency }}</p>
              @if (plan.description) {
                <p class="text-sm mt-1 opacity-90 line-clamp-2">{{ plan.description }}</p>
              }
            </div>
            <span class="shrink-0 text-sm font-bold opacity-90" aria-hidden="true">
              {{ selectedPlan()?.id === plan.id ? '‚ñ≤' : '‚ñº' }}
            </span>
          </button>

          <!-- Cuerpo del formulario: SIEMPRE fondo blanco; solo visible cuando est√° seleccionada -->
          @if (selectedPlan()?.id === plan.id) {
            <div class="px-5 pb-5 pt-0 transition-all duration-300 bg-white border-t border-slate-100">
              <!-- Campos read-only: Nombre, Correo, Tel√©fono -->
              <dl class="space-y-2 text-sm mb-5">
                <div>
                  <dt class="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-1">Nombre completo</dt>
                  <dd class="rounded-lg px-3 py-2.5 bg-slate-50 border border-slate-200 text-slate-500 text-sm">{{ authService.currentUser()?.name ?? '‚Äî' }}</dd>
                </div>
                <div>
                  <dt class="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-1">Correo</dt>
                  <dd class="rounded-lg px-3 py-2.5 bg-slate-50 border border-slate-200 text-slate-500 text-sm">{{ authService.currentUser()?.email ?? '‚Äî' }}</dd>
                </div>
                <div>
                  <dt class="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-1">Tel√©fono</dt>
                  <dd class="rounded-lg px-3 py-2.5 bg-slate-50 border border-slate-200 text-slate-500 text-sm">{{ getCurrentUserPhone() }}</dd>
                </div>
              </dl>

              <div class="space-y-4">
                <div>
                  <label for="category-{{ plan.id }}" class="block text-[10px] font-bold uppercase tracking-wider text-slate-600 mb-1.5">Categor√≠a de Servicio</label>
                  <select
                    id="category-{{ plan.id }}"
                    [value]="serviceCategory()"
                    (change)="serviceCategory.set($any($event.target).value)"
                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-800 focus:ring-2 focus:ring-orange-500/20 focus:border-[#fa5404] outline-none transition-all"
                  >
                    @for (opt of SERVICE_CATEGORIES; track opt.value) {
                      <option [value]="opt.value" class="text-slate-800">{{ opt.label }}</option>
                    }
                  </select>
                </div>
                <div>
                  <label for="work-desc-{{ plan.id }}" class="block text-[10px] font-bold uppercase tracking-wider text-slate-600 mb-1.5">Descripci√≥n del Trabajo</label>
                  <textarea
                    id="work-desc-{{ plan.id }}"
                    [value]="workDescription()"
                    (input)="workDescription.set($any($event.target).value)"
                    placeholder="Cu√©ntanos qu√© quieres construir..."
                    rows="3"
                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-orange-500/20 focus:border-[#fa5404] outline-none transition-all resize-y min-h-[80px]"
                  ></textarea>
                </div>
                <div>
                  <div class="flex items-center gap-2 mb-1.5">
                    <label for="budget-{{ plan.id }}" class="text-[10px] font-bold uppercase tracking-wider text-slate-600">Presupuesto Estimado</label>
                    <span class="w-5 h-5 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500" aria-hidden="true" title="Ayuda">?</span>
                  </div>
                  <input
                    id="budget-{{ plan.id }}"
                    type="number"
                    [value]="estimatedBudget() ?? ''"
                    (input)="estimatedBudget.set($any($event.target).value ? +$any($event.target).value : null)"
                    min="0"
                    step="1"
                    placeholder="0"
                    class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-orange-500/20 focus:border-[#fa5404] outline-none transition-all"
                  />
                  <p class="text-xs text-slate-500 mt-2">¬øNo est√°s seguro? Usa nuestra <a routerLink="/calculadora" class="underline font-bold text-[#fa5404] hover:opacity-80">Calculadora</a> para estimar tu presupuesto.</p>
                </div>
                <div>
                  <button type="button" (click)="onAttachmentsClick()" class="flex items-center gap-2 px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition-colors">
                    <span aria-hidden="true">üìé</span>
                    <span>Adjuntos</span>
                  </button>
                </div>
              </div>

              <!-- Nota destacada -->
              <div class="mt-5 p-4 rounded-xl border-2 border-[#fa5404]/40 bg-[#fa5404]/5 text-slate-700 text-sm">
                Nota: Los pagos est√°n sujetos a cambios seg√∫n la tasa del Banco Central de Venezuela, seg√∫n d√≠a de pago.
              </div>

              <app-loading-button
                label="Solicitar este Plan"
                [isLoading]="isSubmitting()"
                [disabled]="!workDescription().trim()"
                btnClass="mt-5 w-full py-4 px-6 bg-[#fa5404] text-white font-bold rounded-2xl shadow-lg hover:opacity-95 disabled:opacity-60 disabled:cursor-not-allowed transition-all duration-300"
                (clicked)="requestPlan(plan)"
              />
            </div>
          }
        </div>
      }
    </section>
    }

    <!-- Servicios Recientes: √∫ltimos 3 servicios del cliente -->
    <section class="mb-6">
      <h2 class="text-base font-bold text-slate-800 mb-3">Servicios Recientes</h2>
      @if (recentWorks().length > 0) {
        <div class="space-y-3">
          @for (work of recentWorks(); track work.id) {
            <a
              [routerLink]="['/seguimiento']"
              [queryParams]="{ workId: work.id }"
              class="w-full text-left bg-white p-4 rounded-2xl border border-orange-100/50 shadow-sm flex justify-between items-center hover:border-[#fa5404]/40 transition-colors no-underline text-inherit"
            >
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 bg-orange-50 rounded-xl flex items-center justify-center text-lg shrink-0">üèóÔ∏è</div>
                <div class="min-w-0">
                  <p class="font-bold text-slate-800 text-sm truncate">{{ work.title || work.description || 'Solicitud de obra' }}</p>
                  <p class="text-[10px] text-slate-400 font-medium">{{ work.createdAt | date:'dd MMM, yyyy' }}</p>
                </div>
              </div>
              <span
                [class]="getStatusClass(work.status)"
                class="px-2.5 py-1 rounded-full text-[9px] font-bold uppercase shrink-0 ml-2"
              >
                {{ getStatusLabel(work.status) }}
              </span>
            </a>
          }
        </div>
      } @else {
        <div class="rounded-2xl bg-white/60 border-2 border-dashed border-orange-100 p-6 text-center">
          <p class="text-slate-500 text-sm">A√∫n no tienes servicios recientes.</p>
          <p class="text-[10px] text-slate-400 mt-1">Solicita un plan arriba y tus solicitudes aparecer√°n aqu√≠.</p>
        </div>
      }
    </section>
  }

  <!-- ENGINEER: Visitas T√©cnicas de Hoy + bot√≥n Mis Asignaciones -->
  @if (userRole() === 'ENGINEER') {
    <header class="mb-6">
      <h1 class="text-xl font-black text-slate-900 tracking-tight">Visitas T√©cnicas de Hoy</h1>
      <p class="text-slate-500 text-sm mt-0.5">Resumen de tus asignaciones</p>
    </header>
    <div class="rounded-2xl bg-white border border-orange-100/50 shadow-sm p-6 mb-6">
      <p class="text-4xl font-black text-[#fa5404] tabular-nums">{{ todayVisitsCount() }}</p>
      <p class="text-sm font-medium text-slate-600 mt-1">visitas programadas</p>
    </div>
    <a
      routerLink="/engineer"
      class="flex items-center justify-center gap-3 w-full py-4 px-6 bg-[#fa5404] text-white font-bold rounded-[2.5rem] shadow-orange-200 hover:shadow-[0_6px_20px_0_rgba(250,84,4,0.3)] transition-shadow"
    >
      <span class="text-xl leading-none">üìã</span>
      <span>Mis Asignaciones</span>
    </a>
  }

  <!-- SUPERVISOR: KPIs (Cr√©ditos por Aprobar, Obras sin Ingeniero) -->
  @if (userRole() === 'SUPERVISOR') {
    <header class="mb-6">
      <h1 class="text-xl font-black text-slate-900 tracking-tight">Panel de Supervisi√≥n</h1>
      <p class="text-slate-500 text-sm mt-0.5">Indicadores clave</p>
    </header>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="rounded-2xl bg-white border border-orange-100/50 shadow-sm p-5">
        <p class="text-3xl font-black text-slate-900 tabular-nums">{{ creditsPendingCount() }}</p>
        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mt-1">Cr√©ditos por Aprobar</p>
      </div>
      <div class="rounded-2xl bg-white border border-rose-100/50 shadow-sm p-5">
        <p class="text-3xl font-black text-rose-600 tabular-nums">{{ worksUnassignedCount() }}</p>
        <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mt-1">Obras sin Ingeniero</p>
      </div>
    </div>
    <a
      routerLink="/admin"
      class="flex items-center justify-center gap-3 w-full py-4 px-6 bg-[#fa5404] text-white font-bold rounded-[2.5rem] shadow-orange-200 hover:shadow-[0_6px_20px_0_rgba(250,84,4,0.3)] transition-shadow"
    >
      <span class="text-xl leading-none">‚öôÔ∏è</span>
      <span>Gesti√≥n de Cr√©ditos y Asignaci√≥n</span>
    </a>
  }
  }
</div>
