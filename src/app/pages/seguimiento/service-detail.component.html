<div class="min-h-screen bg-orange-50 pb-20">
  @if (loading()) {
    <div class="py-12 text-center text-slate-500 text-sm">Cargando seguimiento…</div>
  } @else if (!workId() || !work()) {
    <!-- Sin obra seleccionada: mismo header que /categories + historial de solicitudes -->
    <header class="flex items-center gap-3 px-4 py-3 border-b border-orange-100/50 bg-white/80">
      <a routerLink="/home" class="p-2 -m-2 rounded-lg hover:bg-orange-100 text-slate-700 transition-colors" aria-label="Volver">
        <lucide-icon [name]="icons.ArrowLeft" class="w-6 h-6"></lucide-icon>
      </a>
      <h1 class="text-xl font-bold text-slate-900">Seguimiento de Servicios</h1>
    </header>

    <div class="p-4 pb-20">
      <p class="text-slate-500 text-sm mb-4">Historial de tus solicitudes de servicio. Toca una para ver el detalle.</p>

      <div class="space-y-2">
        @for (service of serviceHistory(); track service.id) {
          <div
            (click)="openWork(service.id)"
            class="rounded-xl border border-slate-200 bg-white p-4 cursor-pointer hover:shadow-md transition-shadow active:scale-[0.98]"
          >
            <div class="flex justify-between items-center">
              <div class="min-w-0 flex-1">
                <h4 class="font-medium text-foreground">{{ service.title }}</h4>
                <p class="text-sm text-gray-500">{{ service.date }}</p>
              </div>
              <span
                [class]="service.status === 'Finalizado' ? 'bg-green-500 text-white' : 'bg-[#FF5500] text-white'"
                class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shrink-0 ml-2"
              >
                {{ service.status }}
              </span>
            </div>
          </div>
        } @empty {
          <div class="p-8 text-center border-2 border-dashed border-slate-200 rounded-xl">
            <p class="text-sm text-gray-500">No tienes solicitudes de servicio.</p>
          </div>
        }
      </div>
    </div>
  } @else {
    <!-- Header: mismo estilo que /categories (volver + título) -->
    <header class="flex items-center gap-3 px-4 py-3 border-b border-orange-100/50 bg-white/80 sticky top-0 z-10">
      <a routerLink="/home" class="p-2 -m-2 rounded-lg hover:bg-orange-100 text-slate-700 transition-colors" aria-label="Volver">
        <lucide-icon [name]="icons.ArrowLeft" class="w-6 h-6"></lucide-icon>
      </a>
      <h1 class="text-xl font-bold text-slate-900">Seguimiento de Servicio</h1>
    </header>

    <div class="p-4 space-y-4">
      <!-- Card: Info del servicio (Figma) -->
      <section class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-4">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-bold text-lg text-slate-900">{{ work()?.title || work()?.description || 'Solicitud de obra' }}</h3>
              <p class="text-sm text-gray-600">ID: #{{ work()?.id?.slice(0, 8) }}</p>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-[#FF5500] text-white shrink-0">
              {{ getStatusLabel(work()!.status) }}
            </span>
          </div>
          <div class="space-y-2 text-sm">
            @if (visitScheduledDate(); as visitDate) {
              <div class="flex items-center gap-2 text-slate-700">
                <lucide-icon [name]="icons.Clock" class="w-4 h-4 text-slate-500 shrink-0"></lucide-icon>
                <span>Fecha de visita: {{ visitDate | date:'dd/MM/yyyy, HH:mm' }}</span>
              </div>
            }
            @if (estimatedDate(); as date) {
              <div class="flex items-center gap-2 text-slate-700">
                <lucide-icon [name]="icons.Clock" class="w-4 h-4 text-slate-500 shrink-0"></lucide-icon>
                <span>Agendado: {{ date | date:'dd/MM/yyyy, HH:mm' }}</span>
              </div>
            }
            <div class="flex items-center gap-2 text-slate-700">
              <lucide-icon [name]="icons.MapPin" class="w-4 h-4 text-slate-500 shrink-0"></lucide-icon>
              <span>Ubicación: Tu dirección registrada</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Card: Estado del servicio (Figma) - barra + pasos -->
      <section class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-4">
          <h3 class="font-bold text-slate-900 mb-4">Estado del Servicio</h3>
          <div class="h-2 rounded-full bg-slate-200 overflow-hidden mb-4">
            <div class="h-full rounded-full bg-[#FF5500] transition-all duration-300" [style.width.%]="progressPercentage()"></div>
          </div>
          <div class="space-y-3">
            @for (step of steps(); track step.label; let i = $index) {
              <div class="flex items-start gap-3">
                <div class="mt-0.5 rounded-full p-1 shrink-0"
                  [class.bg-green-500]="step.completed"
                  [class.bg-[#FF5500]]="step.current && !step.completed"
                  [class.bg-slate-200]="!step.completed && !step.current">
                  <lucide-icon [name]="icons.CheckCircle2" class="w-4 h-4" [class.text-white]="step.completed || step.current" [class.text-slate-400]="!step.completed && !step.current"></lucide-icon>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-medium text-sm"
                    [class.text-green-700]="step.completed"
                    [class.text-orange-600]="step.current && !step.completed"
                    [class.text-slate-400]="!step.completed && !step.current">
                    {{ step.label }}
                  </p>
                  @if (step.current) {
                    <p class="text-xs text-slate-500 mt-0.5">Estado actual</p>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </section>

      <!-- Card: Tu Técnico (Figma) -->
      <section class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <div class="p-4">
          <h3 class="font-bold text-slate-900 mb-3">Tu Técnico</h3>
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="w-12 h-12 bg-orange-200 rounded-full flex items-center justify-center font-bold text-orange-700 text-sm shrink-0">
                {{ (engineerName() || '?').charAt(0) | uppercase }}
              </div>
              <div class="min-w-0">
                <p class="font-medium text-slate-900">{{ engineerName() || 'Pendiente de asignar' }}</p>
                <p class="text-sm text-slate-500">Responsable de la obra</p>
              </div>
            </div>
            <div class="flex gap-2 shrink-0">
              <a href="tel:" class="w-10 h-10 rounded-full border border-slate-200 flex items-center justify-center text-green-600 hover:bg-green-50 transition-colors" aria-label="Llamar">
                <lucide-icon [name]="icons.Phone" class="w-5 h-5"></lucide-icon>
              </a>
              @if (work()?.engineerId) {
                <a [routerLink]="['/chat']" [state]="{ workId: work()?.id, engineerName: engineerName() }" class="w-10 h-10 rounded-full border border-slate-200 flex items-center justify-center text-blue-600 hover:bg-blue-50 transition-colors no-underline" aria-label="Mensaje">
                  <lucide-icon [name]="icons.MessageCircle" class="w-5 h-5"></lucide-icon>
                </a>
              }
            </div>
          </div>
        </div>
      </section>

      <!-- Acciones (Figma) -->
      @if (work()?.status === 'FINISHED') {
        <div class="space-y-2">
          <a [routerLink]="['/rating']" [state]="{ workId: work()?.id, title: work()?.title, engineerName: engineerName() }"
            class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl font-semibold bg-[#FF5500] text-white hover:bg-[#FF6600] transition-colors no-underline">
            <lucide-icon [name]="icons.Star" class="w-[18px] h-[18px]"></lucide-icon>
            Calificar servicio
          </a>
        </div>
      }

      <!-- Resumen de materiales (existente) -->
      <app-client-material-summary [work]="work()" [engineerName]="engineerName()" />

      <!-- Card: ¿Necesitas ayuda? (Figma) -->
      <section class="rounded-xl border border-blue-200 bg-blue-50 overflow-hidden">
        <div class="p-4">
          <h4 class="font-bold text-slate-900 mb-2">¿Necesitas ayuda?</h4>
          <p class="text-sm text-slate-700 mb-3">Nuestro equipo de soporte está disponible 24/7</p>
          <button type="button" class="w-full py-2.5 px-4 border border-blue-600 text-blue-600 font-medium rounded-lg bg-transparent hover:bg-blue-100 transition-colors">
            Contactar Soporte
          </button>
        </div>
      </section>
    </div>
  }
</div>
