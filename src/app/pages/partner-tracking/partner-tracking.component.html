<div class="min-h-screen bg-brand-light pb-20 font-outfit">
  <header class="p-6 flex items-center justify-between">
    <h1 class="text-2xl font-poppins font-black text-slate-900">Mi Obra Activa</h1>
    <div class="bg-primary/10 p-2 rounded-xl">
      <lucide-icon [name]="icons.AlertTriangle" class="w-5 h-5 text-orange-500"></lucide-icon>
    </div>
  </header>

  <main class="px-6 space-y-8">
    @if (jobsLoading()) {
      <div class="rounded-[2.5rem] bg-white border border-slate-200 shadow-sm p-10 text-center">
        <p class="text-slate-500 text-sm">Cargando obra asignada…</p>
      </div>
    } @else if (job(); as currentJob) {
      @if (currentJob.status === 'PENDING' && currentJob.expiresAt) {
        <section class="bg-card border border-border/40 rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden">
          <div class="relative z-10 flex flex-col items-center text-center space-y-4">
            <span class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-500">Tiempo restante para inicio</span>
            <div [class]="timerColorClass()" class="text-6xl font-black tracking-tighter transition-colors duration-500 flex items-baseline gap-1 drop-shadow-sm">
              <span>{{ timeLeft().hours | number:'2.0-0' }}</span>
              <span class="text-2xl opacity-50">:</span>
              <span>{{ timeLeft().minutes | number:'2.0-0' }}</span>
              <span class="text-2xl opacity-50">:</span>
              <span>{{ timeLeft().seconds | number:'2.0-0' }}</span>
            </div>
            <div class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-full">
              <lucide-icon [name]="icons.Timer" class="w-4 h-4 text-slate-600"></lucide-icon>
              <span class="text-xs font-bold italic text-slate-700">SLA de 48 horas activo</span>
            </div>
          </div>
          <div class="absolute -top-24 -right-24 w-48 h-48 rounded-full blur-[80px] opacity-20 transition-colors"
               [ngClass]="timeLeft().isCritical ? 'bg-red-500' : 'bg-orange-500'"></div>
        </section>
      }

      <section class="space-y-4">
        <div class="bg-primary p-6 rounded-[2rem] text-white relative group active:scale-[0.98] transition-all shadow-orange-200">
          <div class="flex justify-between items-start">
            <div class="space-y-3">
              <h3 class="font-poppins font-bold text-lg leading-tight">{{ currentJob.title }}</h3>
              @if (currentJob.requestCode) {
                <p class="text-white/80 text-xs font-medium">Código {{ currentJob.requestCode }}</p>
              }
              <div class="flex items-start gap-2 text-white/90">
                <lucide-icon [name]="icons.MapPin" class="w-4 h-4 mt-0.5 shrink-0"></lucide-icon>
                <p class="text-sm font-medium">{{ currentJob.clientAddress }}</p>
              </div>
            </div>
            <a [routerLink]="['/partner/service', currentJob.workId]" class="bg-white/10 p-3 rounded-2xl backdrop-blur-md inline-flex items-center justify-center" aria-label="Ver detalle">
              <lucide-icon [name]="icons.ChevronRight" class="w-5 h-5"></lucide-icon>
            </a>
          </div>
        </div>
      </section>

      <section class="grid grid-cols-1 gap-4">
        @if (currentJob.status === 'PENDING') {
          <button type="button" (click)="handlePhotoUpload('START')" [disabled]="isUploadingPhoto()"
            class="w-full h-24 bg-primary text-white rounded-[2rem] shadow-xl shadow-orange-500/30 flex flex-col items-center justify-center gap-1 active:scale-95 transition-all disabled:opacity-60 disabled:pointer-events-none">
            <lucide-icon [name]="icons.Camera" class="w-8 h-8"></lucide-icon>
            <span class="font-black text-xs uppercase tracking-widest">{{ isUploadingPhoto() ? 'Enviando…' : 'Tomar Foto de Inicio' }}</span>
          </button>
          <p class="text-[10px] text-center text-slate-500 px-8">
            Debes cargar una foto del estado actual antes de romper o modificar cualquier área.
          </p>
        } @else if (currentJob.status === 'IN_PROGRESS') {
          <button type="button" (click)="handlePhotoUpload('FINISH')" [disabled]="isUploadingPhoto()"
            class="w-full h-24 bg-green-600 text-white rounded-[2rem] shadow-xl shadow-green-500/30 flex flex-col items-center justify-center gap-1 active:scale-95 transition-all disabled:opacity-60 disabled:pointer-events-none">
            <lucide-icon [name]="icons.Camera" class="w-8 h-8"></lucide-icon>
            <span class="font-black text-xs uppercase tracking-widest">{{ isUploadingPhoto() ? 'Enviando…' : 'Finalizar y Tomar Foto' }}</span>
          </button>
        }
      </section>

      <button type="button" (click)="openExternalSearch()"
        class="w-full py-4 rounded-[2rem] flex items-center justify-center gap-3 font-bold transition-all bg-primary/10 border-2 border-primary text-primary hover:bg-primary/20 active:scale-[0.98]">
        <lucide-icon [name]="icons.MapPin" class="w-5 h-5 shrink-0"></lucide-icon>
        Ver Ferreterías Cercanas
      </button>

      <a [routerLink]="['/chat']" [queryParams]="{ workId: currentJob.workId }"
        class="block w-full py-3 rounded-2xl border-2 border-slate-200 text-slate-700 font-bold text-sm hover:bg-slate-50 transition-colors text-center">
        Chat con el cliente
      </a>

      @if (nextStatusForSimulation(); as next) {
        <button type="button" (click)="advanceToNextStatus()" [disabled]="isAdvancingStatus()"
          class="w-full py-3 rounded-2xl border-2 border-amber-300 bg-amber-50 text-amber-800 font-bold text-sm hover:bg-amber-100 active:scale-[0.98] transition-colors disabled:opacity-60 disabled:pointer-events-none">
          {{ isAdvancingStatus() ? 'Actualizando…' : 'Avanzar a «' + next.label + '» (simulación)' }}
        </button>
      }
    } @else {
      <div class="h-[60vh] flex flex-col items-center justify-center text-center space-y-4">
        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center">
          <lucide-icon [name]="icons.Timer" class="w-10 h-10 text-slate-400"></lucide-icon>
        </div>
        <div>
          <h3 class="font-bold text-slate-800">Sin obras asignadas</h3>
          <p class="text-sm text-slate-500 mt-1">Te avisaremos cuando haya una nueva oportunidad.</p>
        </div>
      </div>
    }
  </main>
</div>
