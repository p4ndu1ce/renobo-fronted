<div class="min-h-screen app-bg pb-40">
  <header class="bg-white border-b border-slate-200 p-6 mb-8 sticky top-0 z-10 shadow-sm">
    <div class="max-w-5xl mx-auto flex justify-between items-center gap-4">
      <h1 class="text-2xl font-black text-slate-900 tracking-tight">RENOBO</h1>
      <div class="flex items-center gap-4 flex-1 justify-end">
        <div class="relative w-64">
          <input type="text" (input)="searchTerm.set($any($event.target).value)" placeholder="Buscar material..."
            class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-full text-sm focus:ring-2 focus:ring-accent outline-none transition-all">
          <span class="absolute left-3 top-2.5 text-slate-400">üîç</span>
        </div>
        @if (authService.isLoggedIn()) {
        <button 
          type="button"
          (click)="logout()"
          class="px-4 py-2 text-sm font-bold text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-all">
          Cerrar Sesi√≥n
        </button>
        }
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    @for (item of filteredServices(); track item.id) {
    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
      <span class="text-[10px] font-bold text-accent uppercase tracking-widest bg-blue-50 px-2 py-1 rounded">{{
        item.category }}</span>
      <h3 class="text-lg font-bold text-slate-800 mt-2">{{ item.name }}</h3>
      <p class="text-slate-500 text-sm mb-4">{{ item.price.value | currency }} / {{ item.unit }}</p>

      <div class="flex items-center gap-3">
        <input 
          type="number" 
          min="0" 
          [value]="cartService.basket().get(item.id) || ''"
          (input)="updateQuantity(item.id, $event)"
          class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-center font-bold focus:border-accent outline-none"
          placeholder="0.00">
        <span class="text-slate-400 font-medium">{{ item.unit }}</span>
      </div>
    </div>
    }
  </main>

  <footer
    class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20">
    <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100 overflow-hidden">
      <div [class]="cartService.progressBarColor()" [style.width.%]="cartService.progressPercentage()"
        class="h-full transition-all duration-700 ease-out shadow-[0_0_10px_rgba(0,0,0,0.1)]"></div>
    </div>

    <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6 mt-2">

      <div class="flex items-center gap-4">
        <div [class]="cartService.recommendedPlan()?.exceeded ? 'bg-orange-100' : 'bg-accent/10'"
          class="p-3 rounded-2xl transition-colors">
          <span class="text-2xl">{{ cartService.recommendedPlan()?.exceeded ? '‚ö†Ô∏è' : 'üí≥' }}</span>
        </div>
        <div>
          @if (cartService.recommendedPlan(); as plan) {
          <p class="text-xs font-bold text-slate-400 uppercase tracking-tighter">
            {{ plan.exceeded ? 'Presupuesto Elevado' : 'Plan Recomendado' }}
          </p>
          <h4 class="text-xl font-black text-slate-900 leading-tight">{{ plan.name }} {{ plan.exceeded ? '+' : '' }}</h4>

          @if (plan.exceeded) {
          <p class="text-[10px] text-orange-600 font-bold uppercase">Requiere Evaluaci√≥n Especial</p>
          } @else if (cartService.grandTotal() > 0) {
          <p class="text-[10px] font-medium text-slate-400">
            Te quedan <span class="text-slate-600 font-bold">{{ (plan.maxAmount - cartService.grandTotal()) | currency }}</span>
            disponibles
          </p>
          }
          } @else {
          <p class="text-slate-400 text-sm italic">Agrega materiales para ver tu plan</p>
          }
        </div>
      </div>

      @if (cartService.grandTotal() > 0) {
      <div class="text-center md:text-left px-8 border-x border-slate-100 hidden md:block">
        <p class="text-xs font-bold text-slate-400 uppercase">Cuota Mensual Est. (12m)</p>
        <p class="text-xl font-bold text-slate-700">{{ cartService.estimatedQuota() | currency }}</p>
      </div>
      }

      <div class="text-right">
        <p class="text-xs font-bold text-slate-400 uppercase">Total Presupuesto</p>
        <p class="text-4xl font-black text-slate-900 leading-none">
          {{ cartService.grandTotal() | currency }}
        </p>
      </div>

      <button 
        type="button"
        (click)="handleRequestCredit()"
        class="w-full md:w-auto px-10 py-4 bg-accent text-white font-black rounded-2xl hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-2 cursor-pointer">
        @if (!authService.isLoggedIn()) {
        <span class="text-sm opacity-80">üîí</span>
        INGRESAR PARA SOLICITAR
        } @else {
        CONTINUAR SOLICITUD
        <span class="text-xl">‚Üí</span>
        }
      </button>

    </div>
  </footer>

  <!-- Bot√≥n flotante para abrir el panel -->
  <button 
    (click)="isCartOpen.set(true)"
    class="fixed top-24 right-6 z-30 bg-white border border-slate-200 p-3 rounded-2xl shadow-xl hover:scale-110 transition-all flex items-center gap-2 group"
  >
    <span class="text-xl">üìã</span>
    <span class="bg-accent text-white text-[10px] font-bold px-2 py-0.5 rounded-full">
      {{ cartService.selectedItemsDetail().length }}
    </span>
  </button>

  <!-- Overlay de fondo -->
  @if (isCartOpen()) {
  <div 
    (click)="isCartOpen.set(false)"
    class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-40 transition-opacity"
  ></div>
  }

  <!-- Panel lateral -->
  <aside 
    [class.translate-x-0]="isCartOpen()"
    [class.translate-x-full]="!isCartOpen()"
    class="fixed top-0 right-0 h-full w-full max-w-md bg-white z-50 shadow-2xl transition-transform duration-300 ease-in-out flex flex-col"
  >
    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
      <h2 class="text-xl font-black text-slate-900 uppercase tracking-tight">Detalle de Obra</h2>
      <button (click)="isCartOpen.set(false)" class="p-2 hover:bg-slate-100 rounded-full transition-colors">‚úï</button>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-4">
      @for (item of cartService.selectedItemsDetail(); track item.id) {
        <div class="flex justify-between items-start border-b border-slate-50 pb-4">
          <div class="flex-1">
            <p class="text-xs font-bold text-accent uppercase">{{ item.category }}</p>
            <p class="font-bold text-slate-800">{{ item.name }}</p>
            <p class="text-sm text-slate-500">{{ item.quantity }} {{ item.unit }} x {{ item.price.value | currency }}</p>
          </div>
          <div class="text-right">
            <p class="font-black text-slate-900">{{ item.subtotal | currency }}</p>
            <button (click)="cartService.removeItem(item.id)" class="text-[10px] text-rose-500 hover:underline">Eliminar</button>
          </div>
        </div>
      } @empty {
        <div class="h-full flex flex-col items-center justify-center text-center opacity-40">
          <span class="text-6xl mb-4">üèóÔ∏è</span>
          <p class="text-slate-500">Tu presupuesto est√° vac√≠o.<br>Agrega partidas para ver el detalle.</p>
        </div>
      }
    </div>

    <div class="p-6 bg-slate-50 border-t border-slate-100">
      <div class="flex justify-between items-center mb-6">
        <span class="font-bold text-slate-500">TOTAL ESTIMADO</span>
        <span class="text-2xl font-black text-slate-900">{{ cartService.grandTotal() | currency }}</span>
      </div>
      <button 
        (click)="isCartOpen.set(false); handleRequestCredit()"
        class="w-full py-4 bg-accent text-white font-black rounded-2xl shadow-lg shadow-blue-100"
      >
        SOLICITAR CR√âDITO AHORA
      </button>
    </div>
  </aside>

</div>
